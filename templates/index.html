{% extends "base.html" %} {% block title %}Dashboard - LMS Activity Monitor{%
endblock %} {% block content %}
<div class="dashboard">
  <div class="page-header">
    <h1>ðŸ“Š Dashboard</h1>
    <div class="actions">
      <button onclick="triggerScan()" class="btn btn-primary">
        <i class="fas fa-sync"></i> Run Scan Now
      </button>
      <button onclick="testEmail()" class="btn btn-secondary">
        <i class="fas fa-envelope"></i> Test Email
      </button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon" style="background: #667eea">
        <i class="fas fa-book"></i>
      </div>
      <div class="stat-content">
        <h3>{{ stats.total_courses }}</h3>
        <p>Total Courses</p>
        <small
          >OUSL: {{ stats.ousl_courses }} | RJTA: {{ stats.rjta_courses
          }}</small
        >
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background: #764ba2">
        <i class="fas fa-tasks"></i>
      </div>
      <div class="stat-content">
        <h3>{{ stats.total_activities }}</h3>
        <p>Total Activities</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background: #f093fb">
        <i class="fas fa-bell"></i>
      </div>
      <div class="stat-content">
        <h3 id="new-activities-count">{{ stats.new_activities }}</h3>
        <p>New Activities</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background: #4facfe">
        <i class="fas fa-clock"></i>
      </div>
      <div class="stat-content">
        <h3>
          {{ stats.last_scan_time|timeonly if stats.last_scan_time else 'Never'
          }}
        </h3>
        <p>Last Scan</p>
      </div>
    </div>
  </div>

  {% if stats.new_activities > 0 %}
  <div class="alert alert-info">
    <i class="fas fa-info-circle"></i>
    <strong>You have {{ stats.new_activities }} new activities!</strong> Check
    your email or view them below.
  </div>
  {% endif %}

  <!-- Upcoming Deadlines Section -->
  {% if upcoming_deadlines %}
  <div class="card deadline-card">
    <div class="card-header">
      <h2><i class="fas fa-exclamation-triangle"></i> Upcoming Deadlines</h2>
    </div>
    <div class="card-body">
      <div class="deadline-list">
        {% for activity in upcoming_deadlines %}
        <div class="deadline-item {% if activity.is_new %}new{% endif %}">
          <div class="deadline-date">
            <div class="date-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="date-text">
              <strong>{{ activity.deadline }}</strong>
            </div>
          </div>
          <div class="deadline-content">
            <span class="activity-type">{{ activity.activity_type }}</span>
            <h4>{{ activity.title }}</h4>
            <p class="activity-course">
              <i class="fas fa-book"></i> {{ activity.course_name }}
              <span class="lms-badge">{{ activity.lms_name }}</span>
            </p>
          </div>
          {% if activity.url %}
          <a href="{{ activity.url }}" target="_blank" class="btn btn-small">
            <i class="fas fa-external-link-alt"></i> View
          </a>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Tabbed Activities Section -->
  <div class="card">
    <div class="card-header">
      <h2>
        <i class="fas fa-graduation-cap"></i> Recent Activities by University
      </h2>
    </div>
    <div class="tabs">
      <button class="tab-button active" onclick="openTab(event, 'ousl')">
        <i class="fas fa-university"></i> OUSL ({{ ousl_activities|length }})
      </button>
      <button class="tab-button" onclick="openTab(event, 'rjta')">
        <i class="fas fa-university"></i> Rajarata ({{ rjta_activities|length
        }})
      </button>
      <button class="tab-button" onclick="openTab(event, 'all')">
        <i class="fas fa-list"></i> All Activities
      </button>
    </div>

    <!-- OUSL Tab -->
    <div id="ousl" class="tab-content active">
      <div class="card-body">
        {% if ousl_activities %}
        <div class="activity-list">
          {% for activity in ousl_activities %}
          <div class="activity-item {% if activity.is_new %}new{% endif %}">
            <div class="activity-icon">
              {% if activity.activity_type == 'assign' %}
              <i class="fas fa-file-alt"></i>
              {% elif activity.activity_type == 'quiz' %}
              <i class="fas fa-question-circle"></i>
              {% elif activity.activity_type == 'resource' %}
              <i class="fas fa-file"></i>
              {% elif activity.activity_type == 'forum' %}
              <i class="fas fa-comments"></i>
              {% else %}
              <i class="fas fa-book-open"></i>
              {% endif %}
            </div>
            <div class="activity-content">
              <div class="activity-header">
                <span class="activity-type">{{ activity.activity_type }}</span>
                {% if activity.is_new %}
                <span class="badge badge-new">NEW</span>
                {% endif %}
              </div>
              <h4>{{ activity.title }}</h4>
              <p class="activity-course">
                <i class="fas fa-book"></i> {{ activity.course_name }}
              </p>
              {% if activity.deadline %}
              <p class="activity-deadline">
                <i class="fas fa-clock"></i> Deadline: {{ activity.deadline }}
              </p>
              {% endif %}
              <p class="activity-time">{{ activity.first_seen|timeago }}</p>
            </div>
            {% if activity.url %}
            <a href="{{ activity.url }}" target="_blank" class="btn btn-small">
              <i class="fas fa-external-link-alt"></i> View
            </a>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        <div style="text-align: center; margin-top: 1rem">
          <a href="/courses?lms=OUSL" class="btn btn-secondary"
            >View All OUSL Courses</a
          >
        </div>
        {% else %}
        <p class="empty-state">
          No OUSL activities found yet. Run a scan to get started!
        </p>
        {% endif %}
      </div>
    </div>

    <!-- RJTA Tab -->
    <div id="rjta" class="tab-content">
      <div class="card-body">
        {% if rjta_activities %}
        <div class="activity-list">
          {% for activity in rjta_activities %}
          <div class="activity-item {% if activity.is_new %}new{% endif %}">
            <div class="activity-icon">
              {% if activity.activity_type == 'assign' %}
              <i class="fas fa-file-alt"></i>
              {% elif activity.activity_type == 'quiz' %}
              <i class="fas fa-question-circle"></i>
              {% elif activity.activity_type == 'resource' %}
              <i class="fas fa-file"></i>
              {% elif activity.activity_type == 'forum' %}
              <i class="fas fa-comments"></i>
              {% else %}
              <i class="fas fa-book-open"></i>
              {% endif %}
            </div>
            <div class="activity-content">
              <div class="activity-header">
                <span class="activity-type">{{ activity.activity_type }}</span>
                {% if activity.is_new %}
                <span class="badge badge-new">NEW</span>
                {% endif %}
              </div>
              <h4>{{ activity.title }}</h4>
              <p class="activity-course">
                <i class="fas fa-book"></i> {{ activity.course_name }}
              </p>
              {% if activity.deadline %}
              <p class="activity-deadline">
                <i class="fas fa-clock"></i> Deadline: {{ activity.deadline }}
              </p>
              {% endif %}
              <p class="activity-time">{{ activity.first_seen|timeago }}</p>
            </div>
            {% if activity.url %}
            <a href="{{ activity.url }}" target="_blank" class="btn btn-small">
              <i class="fas fa-external-link-alt"></i> View
            </a>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        <div style="text-align: center; margin-top: 1rem">
          <a href="/courses?lms=RJTA" class="btn btn-secondary"
            >View All RJTA Courses</a
          >
        </div>
        {% else %}
        <p class="empty-state">
          No Rajarata activities found yet. Run a scan to get started!
        </p>
        {% endif %}
      </div>
    </div>

    <!-- All Activities Tab -->
    <div id="all" class="tab-content">
      <div class="card-body">
        {% if recent_activities %}
        <div class="activity-list">
          {% for activity in recent_activities %}
          <div class="activity-item {% if activity.is_new %}new{% endif %}">
            <div class="activity-icon">
              {% if activity.activity_type == 'assign' %}
              <i class="fas fa-file-alt"></i>
              {% elif activity.activity_type == 'quiz' %}
              <i class="fas fa-question-circle"></i>
              {% elif activity.activity_type == 'resource' %}
              <i class="fas fa-file"></i>
              {% elif activity.activity_type == 'forum' %}
              <i class="fas fa-comments"></i>
              {% else %}
              <i class="fas fa-book-open"></i>
              {% endif %}
            </div>
            <div class="activity-content">
              <div class="activity-header">
                <span class="activity-type">{{ activity.activity_type }}</span>
                {% if activity.is_new %}
                <span class="badge badge-new">NEW</span>
                {% endif %}
              </div>
              <h4>{{ activity.title }}</h4>
              <p class="activity-course">
                <i class="fas fa-book"></i> {{ activity.course_name }}
                <span class="lms-badge">{{ activity.lms_name }}</span>
              </p>
              {% if activity.deadline %}
              <p class="activity-deadline">
                <i class="fas fa-clock"></i> Deadline: {{ activity.deadline }}
              </p>
              {% endif %}
              <p class="activity-time">{{ activity.first_seen|timeago }}</p>
            </div>
            {% if activity.url %}
            <a href="{{ activity.url }}" target="_blank" class="btn btn-small">
              <i class="fas fa-external-link-alt"></i> View
            </a>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        <div style="text-align: center; margin-top: 1rem">
          <a href="/activities" class="btn btn-secondary"
            >View All Activities</a
          >
        </div>
        {% else %}
        <p class="empty-state">
          No activities found yet. Run a scan to get started!
        </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Scan History (Sidebar) -->
  <div class="card">
    <div class="card-header">
      <h2><i class="fas fa-history"></i> Scan History</h2>
    </div>
    <div class="card-body">
      {% if scan_history %}
      <div class="scan-history">
        {% for scan in scan_history %}
        <div class="scan-item">
          <div class="scan-time">
            {{ scan.scan_time|datetime('%b %d, %H:%M') }}
          </div>
          <div class="scan-info">
            <strong>{{ scan.lms_name }}</strong>
            <span class="scan-stats">
              {{ scan.courses_found }} courses, {{ scan.new_activities }} new
            </span>
          </div>
          <div class="scan-status">
            {% if scan.status == 'success' %}
            <span class="status-success"
              ><i class="fas fa-check-circle"></i
            ></span>
            {% else %}
            <span class="status-error"
              ><i class="fas fa-times-circle"></i
            ></span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="empty-state">No scan history yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<div id="notification" class="notification" style="display: none"></div>
{% endblock %} {% block scripts %}
<script>
  function openTab(evt, tabName) {
    // Hide all tab contents
    var tabContents = document.getElementsByClassName("tab-content");
    for (var i = 0; i < tabContents.length; i++) {
      tabContents[i].classList.remove("active");
    }

    // Remove active class from all buttons
    var tabButtons = document.getElementsByClassName("tab-button");
    for (var i = 0; i < tabButtons.length; i++) {
      tabButtons[i].classList.remove("active");
    }

    // Show the selected tab and mark button as active
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
  }

  function showNotification(message, type = "info") {
    const notification = document.getElementById("notification");
    notification.textContent = message;
    notification.className = `notification notification-${type}`;
    notification.style.display = "block";

    setTimeout(() => {
      notification.style.display = "none";
    }, 5000);
  }

  function triggerScan() {
    showNotification("Starting scan... This may take a few minutes.", "info");

    fetch("/api/scan", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification(data.message, "success");
          setTimeout(() => location.reload(), 2000);
        } else {
          showNotification(data.message, "error");
        }
      })
      .catch((error) => {
        showNotification("Scan failed: " + error.message, "error");
      });
  }

  function testEmail() {
    showNotification("Sending test email...", "info");

    fetch("/api/test-email", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification(data.message, "success");
        } else {
          showNotification(data.message, "error");
        }
      })
      .catch((error) => {
        showNotification("Test failed: " + error.message, "error");
      });
  }
</script>
{% endblock %}
